{% extends "base.html" %}

{% block content %}
    <h1>{{ movie.title }}</h1>
    <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }}">
    <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
    <p><strong>Overview:</strong> {{ movie.overview }}</p>
    <p><a href="{% url 'reviews:movie_search' %}">Back to Search</a></p>

    <h2>Submit a Plot Twist</h2>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Submit Plot Twist</button>
    </form>

    <h2>Plot Twists</h2>
    {% for plot_twist in plot_twists %}
        <div>
            <p>{{ plot_twist.description }} - Votes: <span id="votes-{{ plot_twist.id }}">{{ plot_twist.votes }}</span></p>
            <form method="post" action="{% url 'upvote_plot_twist' plot_twist.id %}" class="vote-form" data-plot-twist-id="{{ plot_twist.id }}">
                {% csrf_token %}
                <button type="submit">Upvote</button>
            </form>
            <form method="post" action="{% url 'downvote_plot_twist' plot_twist.id %}" class="vote-form" data-plot-twist-id="{{ plot_twist.id }}">
                {% csrf_token %}
                <button type="submit">Downvote</button>
            </form>
            <a href="{% url 'edit_plot_twist' movie.id plot_twist.id %}">Edit</a>
            <form method="post" action="{% url 'delete_plot_twist' movie.id plot_twist.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Are you sure you want to delete this plot twist?');">Delete</button>
            </form>
        </div>
    {% empty %}
        <p>No plot twists have been submitted yet.</p>
    {% endfor %}

    <script>
        document.querySelectorAll('.vote-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();  // Prevent the normal form submission
                const formData = new FormData(form);
                const plotTwistId = form.dataset.plotTwistId;  // Use data attribute for reliability
    
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')  // Include CSRF token
                    }
                }).then(response => response.json())
                .then(data => {
                    console.log('Looking for element with ID: votes-' + plotTwistId);
                    console.log('Element found:', document.getElementById('votes-' + plotTwistId));
                    console.log('Data received:', data);
    
                    if (document.getElementById('votes-' + plotTwistId)) {
                        document.getElementById('votes-' + plotTwistId).textContent = data.votes;  // Update votes count on page
                    } else {
                        console.error('Element not found for ID: votes-' + plotTwistId);
                    }
                }).catch(error => console.error('Error:', error));
            });
        });
    </script>
    
    
{% endblock %}

